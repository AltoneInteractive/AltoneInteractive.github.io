<!DOCTYPE html>
<html lang="en" class="dark-mode">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Ichrolic Translator</title>
	<style>
		:root {
			--bg-color: #f5f5f5;
			--container-bg: white;
			--text-color: #333;
			--heading-color: #3a506b;
			--border-color: #ccc;
			--button-bg: #3a506b;
			--button-text: white;
			--button-hover: #1c2541;
			--settings-bg: #f9f9f9;
			--table-header-bg: #f2f2f2;
			--table-border: #ddd;
			--table-hover: #f9f9f9;
			--synonym-row-bg: #f0f8ff;
			--synonym-row-hover: #e6f2ff;
			--box-shadow: rgba(0, 0, 0, 0.1);
		}

		html.dark-mode {
			--bg-color: #1e1e1e;
			--container-bg: #2d2d2d;
			--text-color: #e0e0e0;
			--heading-color: #7dbe90;
			--border-color: #444;
			--button-bg: #7dbe90;
			--button-text: #193b27;
			--button-hover: #7dbe90;
			--settings-bg: #383838;
			--table-header-bg: #3b4252;
			--table-border: #555;
			--table-hover: #3b4252;
			--synonym-row-bg: #2c303f;
			--synonym-row-hover: #434c5e;
			--box-shadow: rgba(0, 0, 0, 0.3);
		}

		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background-color: var(--bg-color);
			color: var(--text-color);
			padding: 20px;
			max-width: 900px;
			margin: 0 auto;
			transition: background-color 0.3s ease, color 0.3s ease;
		}

		.container {
			background-color: var(--container-bg);
			border-radius: 10px;
			box-shadow: 0 4px 8px var(--box-shadow);
			padding: 20px;
			position: relative;
		}

		/* Developer mode dropdown styles */
		.dev-menu {
			position: absolute;
			top: 20px;
			left: 20px;
			display: none;
		}

		.dev-menu.show {
			display: block;
		}

		.dev-menu-toggle {
			background-color: var(--button-bg);
			color: var(--button-text);
			border: none;
			padding: 8px 12px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 18px;
			line-height: 1;
		}

		.dev-menu-toggle.dev-mode {
			background-color: #808080;
			color: white;
		}

		.dev-menu-toggle:hover {
			background-color: var(--button-hover);
		}

		.dev-menu-toggle.dev-mode:hover {
			background-color: #696969;
		}

		.dev-menu-dropdown {
			position: absolute;
			top: 100%;
			left: 0;
			margin-top: 5px;
			background-color: var(--container-bg);
			border: 1px solid var(--border-color);
			border-radius: 5px;
			box-shadow: 0 4px 8px var(--box-shadow);
			min-width: 160px;
			z-index: 1000;
			display: none;
		}

		.dev-menu-dropdown.show {
			display: block;
		}

		.dev-menu-item {
			padding: 10px 15px;
			cursor: pointer;
			border-bottom: 1px solid var(--border-color);
			transition: background-color 0.2s ease;
			white-space: nowrap;
		}

		.dev-menu-item:last-child {
			border-bottom: none;
		}

		.dev-menu-item:hover {
			background-color: var(--table-hover);
		}

		/* Sign-in modal styles */
		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 2000;
		}

		.modal-overlay.show {
			display: flex;
		}

		.modal {
			background-color: var(--container-bg);
			border-radius: 10px;
			box-shadow: 0 8px 16px var(--box-shadow);
			padding: 30px;
			max-width: 500px;
			width: 90%;
			max-height: 80vh;
			overflow-y: auto;
		}

		.modal h2 {
			color: var(--heading-color);
			margin-bottom: 20px;
			text-align: center;
		}

		.modal p {
			margin-bottom: 15px;
			line-height: 1.5;
		}

		.modal input {
			width: 100%;
			padding: 10px;
			border: 1px solid var(--border-color);
			border-radius: 5px;
			margin-bottom: 15px;
			font-family: inherit;
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}

		.modal-buttons {
			display: flex;
			gap: 10px;
			justify-content: flex-end;
		}

		.modal-buttons button {
			padding: 10px 20px;
		}

		.modal a {
			color: var(--heading-color);
			text-decoration: none;
		}

		.modal a:hover {
			text-decoration: underline;
		}

		.cancel-button {
			background-color: #6c757d;
			color: white;
		}

		.cancel-button:hover {
			background-color: #5a6268;
		}

		/* Loading state for buttons */
		.loading {
			opacity: 0.6;
			cursor: not-allowed;
			position: relative;
		}

		.loading:after {
			content: '';
			position: absolute;
			width: 16px;
			height: 16px;
			margin: auto;
			border: 2px solid transparent;
			border-top-color: currentColor;
			border-radius: 50%;
			animation: spin 1s linear infinite;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
		}

		@keyframes spin {
			0% { transform: translate(-50%, -50%) rotate(0deg); }
			100% { transform: translate(-50%, -50%) rotate(360deg); }
		}

		/* Signed in indicator */
		.signed-in-indicator {
			color: #28a745;
			font-size: 12px;
		}

		/* Goldenrod button style for developer mode */
		.goldenrod-button {
			background-color: #DAA520 !important;
			color: #8B4513 !important;
		}

		.goldenrod-button:hover {
			background-color: #B8860B !important;
		}
		h1 {
			color: var(--heading-color);
			text-align: center;
			margin-bottom: 30px;
			transition: margin-left 0.3s ease;
		}

		/* Only apply dev mode margin on mobile/smaller screens */
		@media (max-width: 768px) {
			h1.dev-mode {
				margin-left: 60px; /* Make room for dev menu only in dev mode on mobile */
			}
		}
		.translator {
			display: flex;
			flex-direction: column;
			gap: 20px;
		}
		.text-areas {
			display: flex;
			gap: 20px;
		}
		@media (max-width: 768px) {
			.text-areas {
				flex-direction: column;
			}
		}
		.text-column {
			flex: 1;
			display: flex;
			flex-direction: column;
		}
		.header {
			font-weight: bold;
			margin-bottom: 5px;
		}
		
		/* Click to copy header styling */
		.copy-header {
			font-size: 0.85em;
			color: #666;
		}
		
		html.dark-mode .copy-header {
			color: #999;
		}
		/* Complete text area styling with focus states */
		textarea {
			height: 200px;
			padding: 10px;
			border: 1px solid var(--border-color);
			border-radius: 5px;
			resize: none;
			font-size: 16px;
			font-family: inherit;
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important; /* Force text color */
			transition: border-color 0.2s ease, outline-color 0.2s ease;
			-webkit-text-fill-color: var(--text-color); /* For WebKit browsers */
		}

		textarea:focus {
			background-color: var(--container-bg) !important; /* Force override */
			color: var(--text-color) !important; /* Force override */
			border-color: var(--heading-color);
			outline: 1px solid var(--heading-color);
			outline-offset: -1px; /* Keep outline tight to the border */
			-webkit-text-fill-color: var(--text-color); /* For WebKit browsers */
		}

		/* For webkit browsers like Chrome/Safari */
		textarea:focus-visible {
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}
		
		/* Fix for Firefox */
		textarea:-moz-ui-invalid {
			box-shadow: none;
		}
		
		/* Force text color for all input states */
		textarea:active, textarea:hover, textarea:focus {
			color: var(--text-color) !important;
		}

		/* Special styling for the Ichrolic output textarea */
		#ichrolicOutput {
			cursor: pointer;
			user-select: none;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			position: relative;
			transition: all 0.2s ease;
		}

		#ichrolicOutput:hover {
			background-color: var(--table-hover) !important;
			border-color: var(--heading-color);
		}

		/* Copy feedback styling */
		.copy-feedback {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background-color: var(--heading-color);
			color: var(--button-text);
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 14px;
			font-weight: bold;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
			z-index: 100;
		}

		.copy-feedback.show {
			opacity: 1;
		}

		/* Ambiguous word styling */
		.ambiguous-word {
			text-decoration: underline;
			text-decoration-style: dotted;
			text-decoration-color: var(--heading-color);
			cursor: pointer;
			position: relative;
			padding: 1px 2px;
			border-radius: 3px;
			transition: background-color 0.2s ease;
		}

		.ambiguous-word:hover {
			background-color: var(--table-hover);
		}

		/* Tooltip styling */
		.word-tooltip {
			position: absolute;
			bottom: 100%;
			left: 50%;
			transform: translateX(-50%);
			background-color: var(--heading-color);
			color: var(--button-text);
			padding: 4px 8px;
			border-radius: 4px;
			font-size: 11px;
			font-weight: bold;
			white-space: nowrap;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.2s ease;
			z-index: 200;
			margin-bottom: 5px;
		}

		.word-tooltip::after {
			content: '';
			position: absolute;
			top: 100%;
			left: 50%;
			transform: translateX(-50%);
			border: 4px solid transparent;
			border-top-color: var(--heading-color);
		}

		.ambiguous-word:hover .word-tooltip {
			opacity: 1;
		}

		.settings {
			background-color: var(--settings-bg);
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}
		.settings-header {
			font-weight: bold;
			margin-bottom: 10px;
		}
		.settings-grid {
			display: grid;
			grid-template-rows: repeat(2, 1fr);
			grid-auto-flow: column;
			grid-auto-columns: max-content;
			gap: 10px 20px;
		}
		.setting {
			display: flex;
			align-items: center;
		}
		.setting label {
			margin-left: 8px;
		}
		
		/* Dev-only settings */
		.dev-only-setting {
			display: none;
		}
		
		.dev-mode .dev-only-setting {
			display: flex;
		}
		.dictionary-controls {
			margin-top: 20px;
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}
		.dictionary-status {
			margin-top: 10px;
			font-style: italic;
			color: #666;
		}
		html.dark-mode .dictionary-status {
			color: #aaa;
		}
		.add-entry #synonymToggle {
			padding: 5px 10px;
			background-color: #6c757d;
			min-width: 40px;
		}
		button {
			background-color: var(--button-bg);
			color: var(--button-text);
			border: none;
			padding: 8px 15px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
		}
		button:hover {
			background-color: var(--button-hover);
		}
		.dictionary-table {
			margin-top: 20px;
			max-height: 300px;
			overflow-y: auto;
			border: 1px solid var(--table-border);
			border-radius: 5px;
		}
		.dictionary-search {
			margin-bottom: 15px;
			width: 100%;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.dictionary-search input {
			flex: 1;
			padding: 8px;
			border: 1px solid var(--border-color);
			border-radius: 5px;
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}
		
		/* Fix for all input elements */
		input[type="text"] {
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}
		
		input[type="text"]:focus, input[type="text"]:active, input[type="text"]:hover {
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}
		.dictionary-search .setting {
			margin-bottom: 0;
			white-space: nowrap;
			padding-right: 8px;
		}
		.dictionary-fixed-header {
			position: sticky;
			top: 0;
			background-color: var(--container-bg);
			padding: 15px 0;
			z-index: 10;
			border-bottom: 1px solid var(--border-color);
		}
		
		/* Mobile-friendly table styles */
		.table-responsive {
			overflow-x: auto;
			width: 100%;
		}
		
		@media (max-width: 768px) {
			.table-container {
				margin: 0 -15px; /* Negative margin to allow full-width scrolling */
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
			}
			
			.mobile-table {
				display: flex;
				flex-direction: column;
				margin-top: 15px;
			}
			
			.mobile-table-entry {
				border: 1px solid var(--table-border);
				border-radius: 5px;
				margin-bottom: 10px;
				padding: 10px;
				background-color: var(--container-bg);
			}
			
			.mobile-table-entry.synonym-row {
				background-color: var(--synonym-row-bg);
			}
			
			.mobile-table-row {
				display: flex;
				justify-content: space-between;
				margin-bottom: 5px;
				flex-wrap: wrap;
			}
			
			.mobile-table-label {
				font-weight: bold;
				margin-right: 10px;
				min-width: 70px;
			}
			
			.mobile-table-actions {
				display: flex;
				gap: 5px;
				margin-top: 10px;
				flex-wrap: wrap;
			}
		}
		
		/* Regular table for larger screens */
		@media (min-width: 769px) {
			table {
				width: 100%;
				border-collapse: collapse;
			}
			th, td {
				padding: 8px 12px;
				text-align: left;
				border-bottom: 1px solid var(--table-border);
			}
			th {
				background-color: var(--table-header-bg);
				color: var(--text-color);
				position: sticky;
				top: 0;
			}
			tr:hover {
				background-color: var(--table-hover);
			}
			tr.synonym-row {
				background-color: var(--synonym-row-bg);
			}
			tr.synonym-row:hover {
				background-color: var(--synonym-row-hover);
			}
			.mobile-table {
				display: none;
			}
		}
		
		.add-entry {
			margin-top: 20px;
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}
		.add-entry input {
			flex: 1;
			padding: 8px;
			border: 1px solid var(--border-color);
			border-radius: 5px;
			background-color: var(--container-bg) !important;
			color: var(--text-color) !important;
			-webkit-text-fill-color: var(--text-color);
		}
		.empty-dictionary {
			padding: 20px;
			text-align: center;
			color: #666;
			font-style: italic;
		}
		html.dark-mode .empty-dictionary {
			color: #aaa;
		}
		.sort-indicator {
			display: inline-block;
		}
		
		/* Dark mode toggle styles */
		.dark-mode-toggle {
			position: absolute;
			top: 20px;
			right: 20px;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		
		@media (max-width: 422px) {
			.dark-mode-toggle {
				top: 15px;
				right: 15px;
			}
			
			.mode-toggle-emoji {
				cursor: pointer;
				font-size: 24px;
				line-height: 1;
				display: block;
			}
			
			.toggle-switch, .mode-icon {
				display: none !important;
			}
		}
		
		@media (min-width: 423px) {
			.mode-toggle-emoji {
				display: none;
			}
		}
		
		.toggle-switch {
			position: relative;
			display: inline-block;
			width: 60px;
			height: 30px;
		}
		.toggle-switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}
		.toggle-slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 34px;
		}
		.toggle-slider:before {
			position: absolute;
			content: "";
			height: 22px;
			width: 22px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}
		input:checked + .toggle-slider {
			background-color: #7dbe90;
		}
		input:checked + .toggle-slider:before {
			transform: translateX(30px);
		}
		.mode-icon {
			font-size: 20px;
		}
		
		/* Mobile title and layout improvements */
		@media (max-width: 768px) {
			h1 {
				text-align: left;
				font-size: 1.5rem; /* Smaller size on mobile */
				margin-bottom: 10px;
				margin-right: 10px; /* Make space for the toggle switch */
			}

			.dark-mode-toggle {
				top: 30px; /* Align with the title */
			}

			.container {
				padding: 15px; /* Slightly reduce padding on mobile */
			}
			
			.dictionary-controls {
				justify-content: space-between;
			}
			
			.dictionary-controls button {
				flex-grow: 1;
				text-align: center;
			}
			
			.add-entry {
				flex-direction: column;
			}
			
			.add-entry input {
				width: 100%;
			}
			
			#synonymToggle {
				align-self: flex-start;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- Developer mode menu -->
		<div class="dev-menu" id="devMenu">
			<button class="dev-menu-toggle" id="devMenuToggle">⋯</button>
			<div class="dev-menu-dropdown" id="devMenuDropdown">
				<div class="dev-menu-item" id="devSignIn">
					<span id="signInText">Sign In</span>
				</div>
				<div class="dev-menu-item" id="devClose">Reset</div>
			</div>
		</div>

		<!-- Sign-in modal -->
		<div class="modal-overlay" id="signInModal">
			<div class="modal">
				<h2>Developer Sign In</h2>
				<p>Enter your GitHub Personal Access Token to enable dictionary updates.</p>
				<p><strong>Required permissions:</strong> Contents, Metadata</p>
				<p><a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank">Create a new token →</a></p>
				<input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
				<div class="modal-buttons">
					<button class="cancel-button" id="cancelSignIn">Cancel</button>
					<button id="confirmSignIn">Sign In</button>
				</div>
			</div>
		</div>

		<h1 id="pageTitle">Ichrolic Translator</h1>

		<div class="dark-mode-toggle">
			<span class="mode-icon">☀️</span>
			<label class="toggle-switch">
				<input type="checkbox" id="darkModeToggle" checked>
				<span class="toggle-slider"></span>
			</label>
			<span class="mode-icon">🌙</span>
			<!-- Added emoji toggle for smaller screens -->
			<span class="mode-toggle-emoji" id="modeToggleEmoji">🌙</span>
		</div>

		<div class="settings">
			<div class="settings-header">Settings</div>
			<div class="settings-grid">
				<div class="setting">
					<input type="checkbox" id="ignoreDiacritics">
					<label for="ignoreDiacritics">Ignore Diacritics</label>
				</div>
				<div class="setting">
					<input type="checkbox" id="useContractions" checked>
					<label for="useContractions">Use Contractions</label>
				</div>
				<div class="setting dev-only-setting">
					<input type="checkbox" id="forceSync">
					<label for="forceSync">Force Sync</label>
				</div>
			</div>
		</div>

		<div class="translator">
			<div class="text-areas">
				<div class="text-column">
					<div class="header">English</div>
					<textarea id="englishInput" placeholder="Enter English text here..."></textarea>
				</div>
				<div class="text-column" style="position: relative;">
					<div class="header">Ichrolic <span class="copy-header">(Click to Copy)</span></div>
					<textarea id="ichrolicOutput" placeholder="Ichrolic translation will appear here..." readonly title="Click to copy to clipboard"></textarea>
					<div class="copy-feedback" id="copyFeedback">Copied! ✓</div>
				</div>
			</div>
		</div>

		<div class="dictionary-controls">
			<button id="saveDictionary">Save Dictionary</button>
			<button id="showDictionary">Show/Hide Dictionary</button>
		</div>
		<div class="dictionary-status" id="dictionaryStatus"></div>

		<div class="dictionary-table" id="dictionaryTable" style="display: none;">
			<div class="dictionary-search">
				<input type="text" id="dictionarySearchInput" placeholder="Search dictionary...">
				<div class="setting">
					<input type="checkbox" id="showSynonyms" checked>
					<label for="showSynonyms">Show Synonyms</label>
				</div>
			</div>

			<div class="add-entry">
				<input type="text" id="newEnglish" placeholder="English word or phrase">
				<button id="synonymToggle" title="Toggle between direct translation and synonym">=</button>
				<input type="text" id="newIchrolic" placeholder="Ichrolic translation">
				<button id="addEntry">Add Entry</button>
			</div>

			<!-- Regular table for desktop view -->
			<div class="table-container">
				<table id="desktopTable">
					<thead>
						<tr>
							<th id="englishHeader">English</th>
							<th id="ichrolicHeader">Ichrolic</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="dictionaryBody">
						<!-- Dictionary entries will be added here -->
					</tbody>
				</table>
			</div>
			
			<!-- Mobile-friendly table layout -->
			<div class="mobile-table" id="mobileTable">
				<!-- Mobile entries will be added here -->
			</div>

			<div id="emptyDictionary" class="empty-dictionary">
				No dictionary entries yet. Add some above!
			</div>
		</div>
	</div>

	<script>
		// Dark mode functionality
		const darkModeToggle = document.getElementById('darkModeToggle');
		const modeToggleEmoji = document.getElementById('modeToggleEmoji');
		const htmlElement = document.documentElement;

		// Function to toggle dark mode
		function toggleDarkMode() {
			htmlElement.classList.toggle('dark-mode');
			localStorage.setItem('darkMode', htmlElement.classList.contains('dark-mode'));
			
			// Update the emoji for small screens
			if (htmlElement.classList.contains('dark-mode')) {
				modeToggleEmoji.textContent = '🌙';
			} else {
				modeToggleEmoji.textContent = '☀️';
			}
		}

		// Event listener for the toggle switch
		darkModeToggle.addEventListener('change', toggleDarkMode);
		
		// Event listener for the emoji toggle (for mobile)
		modeToggleEmoji.addEventListener('click', function() {
			darkModeToggle.checked = !darkModeToggle.checked;
			toggleDarkMode();
		});

		// Set initial state (dark mode by default)
		// We've already added the 'dark-mode' class to the html element

		// Main dictionary and synonyms objects
		let dictionary = {};
		let synonyms = {};

		// DOM Elements
		const synonymToggleButton = document.getElementById('synonymToggle');
		const englishInput = document.getElementById('englishInput');
		const ichrolicOutput = document.getElementById('ichrolicOutput');
		const ignoreDiacriticsCheckbox = document.getElementById('ignoreDiacritics');
		const useContractionsCheckbox = document.getElementById('useContractions');
		const forceSyncCheckbox = document.getElementById('forceSync');
		const saveDictionaryButton = document.getElementById('saveDictionary');
		const showDictionaryButton = document.getElementById('showDictionary');
		const dictionaryStatus = document.getElementById('dictionaryStatus');
		const dictionaryTable = document.getElementById('dictionaryTable');
		const dictionaryBody = document.getElementById('dictionaryBody');
		const mobileTable = document.getElementById('mobileTable');
		const newEnglishInput = document.getElementById('newEnglish');
		const newIchrolicInput = document.getElementById('newIchrolic');
		const addEntryButton = document.getElementById('addEntry');
		const dictionarySearchInput = document.getElementById('dictionarySearchInput');
		const showSynonymsCheckbox = document.getElementById('showSynonyms');
		const englishHeader = document.getElementById('englishHeader');
		const ichrolicHeader = document.getElementById('ichrolicHeader');
		const copyFeedback = document.getElementById('copyFeedback');

		// Developer mode elements
		const pageTitle = document.getElementById('pageTitle');
		const devMenu = document.getElementById('devMenu');
		const devMenuToggle = document.getElementById('devMenuToggle');
		const devMenuDropdown = document.getElementById('devMenuDropdown');
		const devSignIn = document.getElementById('devSignIn');
		const devClose = document.getElementById('devClose');
		const signInText = document.getElementById('signInText');
		const signedInIndicator = document.getElementById('signedInIndicator');
		const signInModal = document.getElementById('signInModal');
		const tokenInput = document.getElementById('tokenInput');
		const confirmSignIn = document.getElementById('confirmSignIn');
		const cancelSignIn = document.getElementById('cancelSignIn');

		let isSynonymMode = false; // Track the current mode
		let isDeveloperMode = false; // Track developer mode
		let githubToken = localStorage.getItem('github_token'); // GitHub token
		let currentUser = null; // Store user info
		let wordVariantSelections = {}; // Track which variant is selected for each ambiguous word

		// Copy to clipboard functionality
		ichrolicOutput.addEventListener('click', function() {
			const text = ichrolicOutput.value;
			if (text.trim() === '') {
				return; // Don't copy if there's no text
			}

			// Use the modern clipboard API if available
			if (navigator.clipboard && navigator.clipboard.writeText) {
				navigator.clipboard.writeText(text).then(function() {
					showCopyFeedback();
				}).catch(function() {
					// Fallback to the older method
					fallbackCopyTextToClipboard(text);
				});
			} else {
				// Fallback for older browsers
				fallbackCopyTextToClipboard(text);
			}
		});

		// Fallback copy method for older browsers
		function fallbackCopyTextToClipboard(text) {
			const textArea = document.createElement("textarea");
			textArea.value = text;
			
			// Avoid scrolling to bottom
			textArea.style.top = "0";
			textArea.style.left = "0";
			textArea.style.position = "fixed";

			document.body.appendChild(textArea);
			textArea.focus();
			textArea.select();

			try {
				const successful = document.execCommand('copy');
				if (successful) {
					showCopyFeedback();
				}
			} catch (err) {
				console.error('Fallback: Oops, unable to copy', err);
			}

			document.body.removeChild(textArea);
		}

		// Show copy feedback animation
		function showCopyFeedback() {
			copyFeedback.classList.add('show');
			setTimeout(() => {
				copyFeedback.classList.remove('show');
			}, 1500);
		}

		// Developer mode functionality
		function enterDeveloperMode() {
			console.log('=== Entering Developer Mode ===');
			isDeveloperMode = true;
			
			// Add dev mode class to title and dev menu toggle
			pageTitle.classList.add('dev-mode');
			devMenuToggle.classList.add('dev-mode');
			
			// Add dev mode class to container to show dev-only settings
			document.querySelector('.container').classList.add('dev-mode');
			
			// Change title based on screen size
			updateDeveloperTitle();
			
			// Show developer menu
			devMenu.classList.add('show');
			console.log('Dev menu shown, button should be visible');
			
			// Change save button text and style
			saveDictionaryButton.textContent = 'Update Dictionary';
			saveDictionaryButton.classList.add('goldenrod-button');
			console.log('Save button updated to:', saveDictionaryButton.textContent);
			
			// Clear the input field only if triggered by typing "/////", not auto-login
			if (englishInput.value === '/////') {
				englishInput.value = '';
				ichrolicOutput.value = '';
				console.log('Cleared input fields (triggered by typing)');
			} else {
				console.log('Auto-login detected, keeping input fields as-is');
			}
		}

		function exitDeveloperMode() {
			isDeveloperMode = false;
			
			// Remove dev mode classes
			pageTitle.classList.remove('dev-mode');
			devMenuToggle.classList.remove('dev-mode');
			document.querySelector('.container').classList.remove('dev-mode');
			
			// Revert title
			pageTitle.textContent = 'Ichrolic Translator';
			
			// Hide developer menu
			devMenu.classList.remove('show');
			devMenuDropdown.classList.remove('show');
			
			// Revert save button text and style
			saveDictionaryButton.textContent = 'Save Dictionary';
			saveDictionaryButton.classList.remove('goldenrod-button');
		}

		function updateDeveloperTitle() {
			if (isDeveloperMode) {
				// Check if we're in mobile view (where emoji toggle is visible)
				if (window.innerWidth <= 422) {
					pageTitle.textContent = ';)';
				} else {
					pageTitle.textContent = 'Ichrolic Editor';
				}
			}
		}

		// Update title on window resize if in developer mode
		window.addEventListener('resize', function() {
			updateDeveloperTitle();
			updateDictionaryTable();
		});

		// Developer menu toggle
		devMenuToggle.addEventListener('click', function(e) {
			e.stopPropagation();
			devMenuDropdown.classList.toggle('show');
		});

		// Close dropdown when clicking outside
		document.addEventListener('click', function() {
			devMenuDropdown.classList.remove('show');
		});

		// Developer menu item event handlers
		devSignIn.addEventListener('click', function() {
			if (githubToken && currentUser) {
				// Already signed in, offer to sign out
				if (confirm(`Sign out from ${currentUser.login}?`)) {
					handleSignOut();
				}
			} else {
				// Not signed in, show sign in modal
				showSignInModal();
			}
			devMenuDropdown.classList.remove('show');
		});

		devClose.addEventListener('click', function() {
			exitDeveloperMode();
			devMenuDropdown.classList.remove('show');
		});

		// Sign-in modal event listeners
		confirmSignIn.addEventListener('click', handleSignIn);
		cancelSignIn.addEventListener('click', hideSignInModal);

		// Close modal when clicking outside
		signInModal.addEventListener('click', function(e) {
			if (e.target === signInModal) {
				hideSignInModal();
			}
		});

		// Handle Enter key in token input
		tokenInput.addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				handleSignIn();
			}
		});

		// Check for developer mode trigger
		englishInput.addEventListener('input', function() {
			if (englishInput.value === '/////') {
				enterDeveloperMode();
			}
		});
		function isMobileView() {
			return window.innerWidth <= 768;
		}



		// Event Listeners
		englishInput.addEventListener('input', function() {
			translateToIchrolic();
			updateEnglishInputDisplay();
		});
		ignoreDiacriticsCheckbox.addEventListener('change', translateToIchrolic);
		useContractionsCheckbox.addEventListener('change', translateToIchrolic);
		saveDictionaryButton.addEventListener('click', saveDictionary);
		showDictionaryButton.addEventListener('click', toggleDictionaryTable);
		addEntryButton.addEventListener('click', addDictionaryEntry);
		dictionarySearchInput.addEventListener('input', updateDictionaryTable);
		showSynonymsCheckbox.addEventListener('change', updateDictionaryTable);
		englishHeader.addEventListener('click', () => sortDictionary('english'));
		ichrolicHeader.addEventListener('click', () => sortDictionary('ichrolic'));
		synonymToggleButton.addEventListener('click', toggleSynonymMode);

		// GitHub API functions
		async function testGitHubToken(token) {
			try {
				const response = await fetch('https://api.github.com/user', {
					headers: {
						'Authorization': `token ${token}`,
						'Accept': 'application/vnd.github.v3+json'
					}
				});
				
				if (response.ok) {
					return await response.json();
				} else {
					throw new Error(`GitHub API error: ${response.status}`);
				}
			} catch (error) {
				throw new Error(`Failed to verify token: ${error.message}`);
			}
		}

		async function fetchCurrentDictionary() {
			try {
				const response = await fetch('https://api.github.com/repos/AltoneInteractive/AltoneInteractive.github.io/contents/dictionary.json', {
					headers: {
						'Authorization': `token ${githubToken}`,
						'Accept': 'application/vnd.github.v3+json'
					}
				});
				
				if (response.ok) {
					return await response.json();
				} else {
					throw new Error(`Failed to fetch dictionary: ${response.status}`);
				}
			} catch (error) {
				throw new Error(`GitHub API error: ${error.message}`);
			}
		}

		async function updateDictionaryOnGitHub(newContent, currentSha) {
			try {
				// Create the JSON string
				const jsonString = JSON.stringify(newContent, null, 2);
				
				// Properly encode UTF-8 to base64
				// First encode as UTF-8 bytes, then convert to base64
				const utf8Bytes = new TextEncoder().encode(jsonString);
				let binaryString = '';
				for (let i = 0; i < utf8Bytes.length; i++) {
					binaryString += String.fromCharCode(utf8Bytes[i]);
				}
				const base64Content = btoa(binaryString);
				
				const response = await fetch('https://api.github.com/repos/AltoneInteractive/AltoneInteractive.github.io/contents/dictionary.json', {
					method: 'PUT',
					headers: {
						'Authorization': `token ${githubToken}`,
						'Accept': 'application/vnd.github.v3+json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						message: `Update dictionary via Ichrolic Editor - ${new Date().toISOString()}`,
						content: base64Content,
						sha: currentSha
					})
				});
				
				if (response.ok) {
					return await response.json();
				} else {
					throw new Error(`Failed to update dictionary: ${response.status}`);
				}
			} catch (error) {
				throw new Error(`Update failed: ${error.message}`);
			}
		}

		// Sign-in functionality
		function showSignInModal() {
			signInModal.classList.add('show');
			tokenInput.value = '';
			tokenInput.focus();
		}

		function hideSignInModal() {
			signInModal.classList.remove('show');
		}

		function updateSignInState() {
			if (githubToken && currentUser) {
				signInText.innerHTML = `${currentUser.login} <span class="signed-in-indicator">✓</span>`;
			} else {
				signInText.textContent = 'Sign In';
			}
		}

		async function handleSignIn() {
			const token = tokenInput.value.trim();
			if (!token) {
				alert('Please enter a GitHub token');
				return;
			}

			// Show loading state
			confirmSignIn.classList.add('loading');
			confirmSignIn.disabled = true;

			try {
				const user = await testGitHubToken(token);
				
				// Store token and user info
				githubToken = token;
				currentUser = user;
				localStorage.setItem('github_token', token);
				localStorage.setItem('github_user', JSON.stringify(user));
				
				updateSignInState();
				hideSignInModal();
				
				dictionaryStatus.textContent = `Signed in as ${user.login}`;
				setTimeout(() => {
					dictionaryStatus.textContent = "";
				}, 3000);
				
			} catch (error) {
				alert(`Sign in failed: ${error.message}`);
			} finally {
				confirmSignIn.classList.remove('loading');
				confirmSignIn.disabled = false;
			}
		}

		function handleSignOut() {
			githubToken = null;
			currentUser = null;
			localStorage.removeItem('github_token');
			localStorage.removeItem('github_user');
			updateSignInState();
			
			// Exit developer mode when signing out
			if (isDeveloperMode) {
				exitDeveloperMode();
			}
			
			dictionaryStatus.textContent = "Signed out";
			setTimeout(() => {
				dictionaryStatus.textContent = "";
			}, 3000);
		}
		function removeDiacriticsForSearch(text) {
			if (!text) return text;

			// Map of characters with diacritics to their base form
			const diacriticMap = {
				"í": "i", "é": "e", "á": "a", "ó": "o", "ú": "u",
				"ì": "i", "è": "e", "à": "a", "ò": "o", "ù": "u",
				"î": "i", "ê": "e", "â": "a", "ô": "o", "û": "u",
				"ï": "i", "ë": "e", "ä": "a", "ö": "o", "ü": "u"
			};

			let result = text.toLowerCase();
			for (const diacritic in diacriticMap) {
				result = result.split(diacritic).join(diacriticMap[diacritic]);
			}

			return result;
		}

		// Function to update the dictionary table
		function updateDictionaryTable() {
			const showSynonyms = showSynonymsCheckbox.checked;
			const searchTerm = dictionarySearchInput.value.toLowerCase();

			// Clear both table views
			dictionaryBody.innerHTML = '';
			mobileTable.innerHTML = '';

			// Get a list of all entries to display
			const entries = [];

			// Add main dictionary entries
			for (const english in dictionary) {
				const normalizedEnglish = removeDiacriticsForSearch(english);
				const normalizedIchrolic = removeDiacriticsForSearch(dictionary[english]);
				const normalizedSearch = removeDiacriticsForSearch(searchTerm);
				
				if (searchTerm === '' ||
					normalizedEnglish.includes(normalizedSearch) ||
					normalizedIchrolic.includes(normalizedSearch)) {
					entries.push({
						english: english,
						ichrolic: dictionary[english],
						isSynonym: false
					});
				}
			}

			// Add synonym entries if enabled
			if (showSynonyms) {
				for (const synonym in synonyms) {
					const canonicalForm = synonyms[synonym];
					if (dictionary.hasOwnProperty(canonicalForm)) {
						const normalizedSynonym = removeDiacriticsForSearch(synonym);
						const normalizedIchrolic = removeDiacriticsForSearch(dictionary[canonicalForm]);
						const normalizedSearch = removeDiacriticsForSearch(searchTerm);
						
						if (searchTerm === '' ||
							normalizedSynonym.includes(normalizedSearch) ||
							normalizedIchrolic.includes(normalizedSearch)) {
							entries.push({
								english: synonym,
								ichrolic: dictionary[canonicalForm],
								isSynonym: true,
								canonicalForm: canonicalForm
							});
						}
					}
				}
			}

			// Sort entries with smart search relevance
			if (searchTerm !== '') {
				// Smart search sorting: exact match -> starts with -> contains
				entries.sort((a, b) => {
					const aEnglish = removeDiacriticsForSearch(a.english);
					const bEnglish = removeDiacriticsForSearch(b.english);
					const aIchrolic = removeDiacriticsForSearch(a.ichrolic);
					const bIchrolic = removeDiacriticsForSearch(b.ichrolic);
					const normalizedSearch = removeDiacriticsForSearch(searchTerm);
					
					// Calculate relevance scores
					const getRelevanceScore = (english, ichrolic) => {
						// Exact match gets highest score
						if (english === normalizedSearch || ichrolic === normalizedSearch) return 100;
						
						// Starts with search term gets high score
						if (english.startsWith(normalizedSearch) || ichrolic.startsWith(normalizedSearch)) return 50;
						
						// Contains search term gets lower score
						if (english.includes(normalizedSearch) || ichrolic.includes(normalizedSearch)) return 10;
						
						return 0;
					};
					
					const scoreA = getRelevanceScore(aEnglish, aIchrolic);
					const scoreB = getRelevanceScore(bEnglish, bIchrolic);
					
					// If scores are different, sort by relevance (higher score first)
					if (scoreA !== scoreB) {
						return scoreB - scoreA;
					}
					
					// If same relevance score, fall back to alphabetical sorting
					const fieldA = currentSortField === 'english' ? aEnglish : aIchrolic;
					const fieldB = currentSortField === 'english' ? bEnglish : bIchrolic;
					
					if (sortDirection === 'asc') {
						return fieldA.localeCompare(fieldB);
					} else {
						return fieldB.localeCompare(fieldA);
					}
				});
			} else {
				// No search term, use regular sorting
				entries.sort((a, b) => {
					const fieldA = currentSortField === 'english' ? a.english.toLowerCase() : a.ichrolic.toLowerCase();
					const fieldB = currentSortField === 'english' ? b.english.toLowerCase() : b.ichrolic.toLowerCase();

					if (sortDirection === 'asc') {
						return fieldA.localeCompare(fieldB);
					} else {
						return fieldB.localeCompare(fieldA);
					}
				});
			}

			// Display entries
			const isMobile = isMobileView();
			
			// Update desktop view
			if (!isMobile) {
				for (const entry of entries) {
					const row = document.createElement('tr');
					if (entry.isSynonym) {
						row.classList.add('synonym-row');
					}

					const englishCell = document.createElement('td');
					englishCell.textContent = entry.english;
					if (entry.isSynonym) {
						englishCell.textContent += ` (→ ${entry.canonicalForm})`;
					}

					const ichrolicCell = document.createElement('td');
					ichrolicCell.textContent = entry.ichrolic;

					const actionsCell = document.createElement('td');

					// Create delete button
					const deleteButton = document.createElement('button');
					deleteButton.textContent = 'Delete';
					deleteButton.style.backgroundColor = '#ec474f';
					deleteButton.style.marginRight = '5px';
					deleteButton.addEventListener('click', function() {
						if (entry.isSynonym) {
							delete synonyms[entry.english];
						} else {
							delete dictionary[entry.english];
						}
						updateDictionaryTable();
						translateToIchrolic();
					});

					actionsCell.appendChild(deleteButton);

					// Create edit button for primary entries
					if (!entry.isSynonym) {
						const editButton = document.createElement('button');
						editButton.textContent = 'Edit';
						editButton.style.marginLeft = '5px';
						editButton.addEventListener('click', function() {
							// Populate the input fields with the current values
							newEnglishInput.value = entry.english;
							newIchrolicInput.value = entry.ichrolic;

							// Remove the old entry
							delete dictionary[entry.english];

							// Focus on the ichrolic input for editing
							newIchrolicInput.focus();

							updateDictionaryTable();
						});
						actionsCell.appendChild(editButton);
					}

					// Only show "Make primary" button for synonyms
					if (entry.isSynonym) {
						const makePrimaryButton = document.createElement('button');
						makePrimaryButton.textContent = 'Make Primary';
						makePrimaryButton.style.backgroundColor = '#a9bbd0';
						makePrimaryButton.style.marginLeft = '5px';
						makePrimaryButton.addEventListener('click', function() {
							// Get the translation from the canonical form
							const translation = dictionary[entry.canonicalForm];

							// Remove the synonym
							delete synonyms[entry.english];

							// Add as a primary entry
							dictionary[entry.english] = translation;

							updateDictionaryTable();
							translateToIchrolic();
						});

						actionsCell.appendChild(makePrimaryButton);
					}

					row.appendChild(englishCell);
					row.appendChild(ichrolicCell);
					row.appendChild(actionsCell);
					dictionaryBody.appendChild(row);
				}
			} else {
				// Mobile view entries
				for (const entry of entries) {
					const entryDiv = document.createElement('div');
					entryDiv.className = 'mobile-table-entry';
					if (entry.isSynonym) {
						entryDiv.classList.add('synonym-row');
					}
					
					// English row
					const englishRow = document.createElement('div');
					englishRow.className = 'mobile-table-row';
					
					const englishLabel = document.createElement('div');
					englishLabel.className = 'mobile-table-label';
					englishLabel.textContent = 'English:';
					
					const englishValue = document.createElement('div');
					englishValue.className = 'mobile-table-value';
					englishValue.textContent = entry.english;
					if (entry.isSynonym) {
						englishValue.textContent += ` (→ ${entry.canonicalForm})`;
					}
					
					englishRow.appendChild(englishLabel);
					englishRow.appendChild(englishValue);
					entryDiv.appendChild(englishRow);
					
					// Ichrolic row
					const ichrolicRow = document.createElement('div');
					ichrolicRow.className = 'mobile-table-row';
					
					const ichrolicLabel = document.createElement('div');
					ichrolicLabel.className = 'mobile-table-label';
					ichrolicLabel.textContent = 'Ichrolic:';
					
					const ichrolicValue = document.createElement('div');
					ichrolicValue.className = 'mobile-table-value';
					ichrolicValue.textContent = entry.ichrolic;
					
					ichrolicRow.appendChild(ichrolicLabel);
					ichrolicRow.appendChild(ichrolicValue);
					entryDiv.appendChild(ichrolicRow);
					
					// Actions row
					const actionsDiv = document.createElement('div');
					actionsDiv.className = 'mobile-table-actions';
					
					// Create delete button
					const deleteButton = document.createElement('button');
					deleteButton.textContent = 'Delete';
					deleteButton.style.backgroundColor = '#ec474f';
					deleteButton.addEventListener('click', function() {
						if (entry.isSynonym) {
							delete synonyms[entry.english];
						} else {
							delete dictionary[entry.english];
						}
						updateDictionaryTable();
						translateToIchrolic();
					});
					
					actionsDiv.appendChild(deleteButton);
					
					// Create edit button for primary entries
					if (!entry.isSynonym) {
						const editButton = document.createElement('button');
						editButton.textContent = 'Edit';
						editButton.addEventListener('click', function() {
							// Populate the input fields with the current values
							newEnglishInput.value = entry.english;
							newIchrolicInput.value = entry.ichrolic;

							// Remove the old entry
							delete dictionary[entry.english];

							// Focus on the ichrolic input for editing
							newIchrolicInput.focus();

							updateDictionaryTable();
						});
						actionsDiv.appendChild(editButton);
					}
					
					// Only show "Make primary" button for synonyms
					if (entry.isSynonym) {
						const makePrimaryButton = document.createElement('button');
						makePrimaryButton.textContent = 'Make Primary';
						makePrimaryButton.style.backgroundColor = '#a9bbd0';
						makePrimaryButton.addEventListener('click', function() {
							// Get the translation from the canonical form
							const translation = dictionary[entry.canonicalForm];

							// Remove the synonym
							delete synonyms[entry.english];

							// Add as a primary entry
							dictionary[entry.english] = translation;

							updateDictionaryTable();
							translateToIchrolic();
						});

						actionsDiv.appendChild(makePrimaryButton);
					}
					
					entryDiv.appendChild(actionsDiv);
					mobileTable.appendChild(entryDiv);
				}
			}

			// Show/hide appropriate view based on screen size
			if (isMobile) {
				document.getElementById('desktopTable').style.display = 'none';
				document.getElementById('mobileTable').style.display = 'block';
			} else {
				document.getElementById('desktopTable').style.display = 'table';
				document.getElementById('mobileTable').style.display = 'none';
			}

			// Update empty dictionary message visibility
			const emptyDictionary = document.getElementById('emptyDictionary');
			if (entries.length === 0) {
				emptyDictionary.style.display = 'block';
			} else {
				emptyDictionary.style.display = 'none';
			}
		}
